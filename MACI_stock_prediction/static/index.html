<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <title>MACI Stock Prediction</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/sidebar.css">
    <script defer src="/static/script.js"></script>
    <script defer src="/static/sidebar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .feature-guidance {
        margin-top: 10px;
        padding: 10px;
        background-color: #f0f8ff;
        border-left: 4px solid #4682b4;
        display: none;
      }
      .info-icon {
        cursor: pointer;
        margin-left: 5px;
        display: inline-block;
        width: 18px;
        height: 18px;
        text-align: center;
        line-height: 18px;
        border-radius: 50%;
        background-color: #4682b4;
        color: white;
        font-size: 14px;
      }
      .agent-info {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 5px;
      }
      .agent-info img {
        width: 40px;
        height: 40px;
        margin-right: 10px;
      }
      .agent-details {
        flex-grow: 1;
      }
      .agent-name {
        font-weight: bold;
        font-size: 1.1em;
      }
      .agent-capabilities {
        font-size: 0.9em;
        color: #666;
      }
      .tips-container {
        margin-top: 10px;
      }
      .result-container {
        width: 100%;
        height: inherit;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        padding: 15px;
        margin-top: 20px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden;
      }

      /* Iteration Step Styles */
      .llm-iteration {
        margin-bottom: 15px;
        padding: 10px;
        background-color: #f8f9fa;
        border-left: 4px solid #4682b4;
        border-radius: 4px;
      }

      .llm-iteration-title {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
      }

      /* Data Retrieval Status Styles */
      .llm-retrieval {
        display: flex;
        align-items: center;
        padding: 8px 10px;
        background-color: #f0f7ff;
        border-radius: 6px;
        margin-bottom: 12px;
      }

      .llm-retrieval-success {
        border-left: 4px solid #28a745;
      }

      .llm-retrieval-error {
        border-left: 4px solid #dc3545;
      }

      .llm-status-icon {
        margin-right: 10px;
        font-size: 16px;
      }

      /* Final Analysis Result Styles */
      .llm-analysis {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8fdff;
        border: 1px solid #e1f0fb;
        border-radius: 8px;
      }

      .llm-analysis-title {
        font-weight: bold;
        font-size: 18px;
        color: #0056b3;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e1f0fb;
      }

      .llm-analysis-content {
        line-height: 1.6;
        color: #333;
      }

      /* Model Information Styles */
      .llm-model-info {
        padding: 8px 12px;
        background-color: #eaf4ff;
        border-radius: 4px;
        margin-bottom: 15px;
        font-size: 14px;
        color: #0066cc;
        display: inline-block;
      }

      /* Formula/Math Expression Styles */
      .llm-math {
        background-color: #f9f9f9;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        overflow-x: auto;
      }

      /* List Styles */
      .llm-list {
        margin-left: 20px;
        margin-bottom: 15px;
      }

      .llm-list-item {
        margin-bottom: 8px;
        position: relative;
        padding-left: 8px;
      }

      .llm-list-item:before {
        content: "•";
        position: absolute;
        left: -12px;
        color: #4682b4;
      }

    </style>
  </head>
  <body>
    <!-- Header Section -->
    <header class="header">
      <img src="/static/images/logo.png" alt="MACI Logo" class="logo">
      <span class="username">Welcome, Demo User</span>
    </header>
    <div class="container">
      <h1>MACI Stock Prediction</h1>
      
      <!-- Agent Information Section -->
      <div class="agent-info">
        <img src="/static/images/agent-icon.png" alt="AI Agent" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM0NjgyYjQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cmVjdCB4PSIyIiB5PSIyIiB3aWR0aD0iMjAiIGhlaWdodD0iOCIgcng9IjIiIHJ5PSIyIj48L3JlY3Q+PHJlY3QgeD0iMiIgeT0iMTQiIHdpZHRoPSIyMCIgaGVpZ2h0PSI4IiByeD0iMiIgcnk9IjIiPjwvcmVjdD48bGluZSB4MT0iNiIgeTE9IjYiIHgyPSI2LjAxIiB5Mj0iNiI+PC9saW5lPjxsaW5lIHgxPSI2IiB5MT0iMTgiIHgyPSI2LjAxIiB5Mj0iMTgiPjwvbGluZT48L3N2Zz4='">
        <div class="agent-details">
          <div class="agent-name" id="agent-name">Investment Research Assistant</div>
          <div class="agent-capabilities" id="agent-capabilities">Ready to assist with financial analysis</div>
        </div>
        <span class="info-icon" onclick="toggleFeatureGuidance()">i</span>
      </div>
      
      <!-- Feature Guidance Section -->
      <div id="feature-guidance" class="feature-guidance">
        <div id="guidance-content">
          Your AI assistant is ready to help with investment research. Ask any finance-related questions!
        </div>
      </div>
      
      <!-- Query Input Section -->
      <input type="text" id="stockSymbols" placeholder="Please enter any questions related to financial, stock (e.g., AAPL,GOOGL)" />

      <!-- Sample Questions Based on Features -->
      <div class="tips-container" id="sample-questions">
        <p><small><strong>Sample questions will appear here based on your agent's capabilities</strong></small></p>
      </div>


      <!--      <button id="queryButton">Get Insights</button>-->
      <button onclick="fetchStockData()">Get Insights</button>
      <button onclick="window.location.href='generate_agent.html'">Configure New Agent</button>
      <!-- Hidden debug output section -->
      <div class="result-container" id="result" style="width: 100%">Results will appear here...</div>

      <canvas id="stockChart"></canvas>
      

    </div>
    
    <script>
      // Load agent configuration when page loads
      document.addEventListener('DOMContentLoaded', function() {
        loadAgentConfig();
      });
      
      // Toggle feature guidance visibility
      function toggleFeatureGuidance() {
        const guidanceDiv = document.getElementById('feature-guidance');
        if (guidanceDiv.style.display === 'none' || guidanceDiv.style.display === '') {
          guidanceDiv.style.display = 'block';
        } else {
          guidanceDiv.style.display = 'none';
        }
      }
      
// In the JavaScript section of index.html, add the following function

// Update input placeholder text
function updatePlaceholder(features) {
  const inputElement = document.getElementById('stockSymbols');
  if (!inputElement) return;
  
  // Default placeholder text
  let placeholder = "Please enter any questions related to financial, stock (e.g., AAPL,GOOGL)";
  
  // Update placeholder text based on selected features
  if (features && features.length > 0) {
    if (features.includes('simple-complex-calculation')) {
      placeholder = "Ask about financial calculations (e.g., 'Calculate AAPL's 5-year growth rate')";
    } 
    else if (features.includes('ml-reasoning')) {
      placeholder = "Ask about market patterns and trends (e.g., 'Analyze TSLA price patterns')";
    }
    else if (features.includes('planning')) {
      placeholder = "Ask about research strategies (e.g., 'Plan research for evaluating tech stocks')";
    }
    else if (features.includes('validation')) {
      placeholder = "Ask about data reliability (e.g., 'Validate recent MSFT earnings reports')";
    }
    else if (features.includes('decision-making')) {
      placeholder = "Ask for investment recommendations (e.g., 'Should I invest in AMZN now?')";
    }
    else if (features.includes('operation')) {
      placeholder = "Ask for summaries or visualizations (e.g., 'Summarize AAPL financial metrics')";
    }
  }
  
  // Apply the new placeholder text
  inputElement.placeholder = placeholder;
}

    // Modify loadAgentConfig function to update placeholder text
    async function loadAgentConfig() {
      try {
        // Get agentId from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const agentId = urlParams.get('agentId');
        
 

        const response = await fetch(`/load_agent/${agentId}`);
        if (!agentId) {
          console.error("No agentId found in URL");
          throw new Error("No agentId provided");
        }
        if (!response.ok) throw new Error("Failed to load agent");

        const responseConfig = await fetch('/get_agent_config');
        const config = await responseConfig.json();
        
        console.log("Loaded config:", config);
        
        updateAgentInfo(config);
        updateFeatureGuidance(config.features);
        updateSampleQuestions(config.features);
        updatePlaceholder(config.features);
        
      } catch (error) {
        console.error("Error loading agent configuration:", error);
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      loadAgentConfig(); // Get agentId from URL
    });
      
      // Update agent information display
      function updateAgentInfo(config) {
        const nameElement = document.getElementById('agent-name');
        const capabilitiesElement = document.getElementById('agent-capabilities');
        
        if (nameElement && config.agent_name) {
          nameElement.textContent = config.agent_name;
        }
        
        if (capabilitiesElement) {
          let capabilities = [];
          
          if (config.features && config.features.length > 0) {
            if (config.features.includes('simple-complex-calculation')) capabilities.push('Calculation');
            if (config.features.includes('ml-reasoning')) capabilities.push('ML Reasoning');
            if (config.features.includes('planning')) capabilities.push('Planning');
            if (config.features.includes('validation')) capabilities.push('Validation');
            if (config.features.includes('decision-making')) capabilities.push('Decision Making');
            if (config.features.includes('operation')) capabilities.push('Operations');
          }
          
          if (capabilities.length > 0) {
            capabilitiesElement.textContent = `Capabilities: ${capabilities.join(', ')}`;
          } else {
            capabilitiesElement.textContent = `Using ${config.model_source || 'AI'} model for financial analysis`;
          }
        }
      }
      
      // Update feature guidance based on selected features
      function updateFeatureGuidance(features) {
        const guidanceContent = document.getElementById('guidance-content');
        if (!guidanceContent) return;
        
        let guidance = "Your AI assistant is ready to help with investment research. ";
        
        if (features && features.length > 0) {
          if (features.includes('simple-complex-calculation')) {
            guidance += "It can perform financial calculations from basic to complex. ";
          }
          
          if (features.includes('ml-reasoning')) {
            guidance += "It can analyze patterns and trends using machine learning concepts. ";
          }
          
          if (features.includes('planning')) {
            guidance += "It uses strategic planning to break down complex research questions. ";
          }
          
          if (features.includes('validation')) {
            guidance += "It validates data and conclusions for reliability. ";
          }
          
          if (features.includes('decision-making')) {
            guidance += "It provides evidence-based investment recommendations. ";
          }
          
          if (features.includes('operation')) {
            guidance += "It can suggest visualizations and provide actionable summaries. ";
          }
        } else {
          guidance += "Ask any finance-related questions!";
        }
        
        guidanceContent.textContent = guidance;
      }
      
      // Update sample questions based on selected features
      function updateSampleQuestions(features) {
        const sampleContainer = document.getElementById('sample-questions');
        if (!sampleContainer) return;
        
        let questions = [];
        
        if (!features || features.length === 0) {
          questions = [
            "What's the current market outlook for AAPL?",
            "Compare GOOGL and MSFT performance this quarter"
          ];
        } else {
          if (features.includes('simple-complex-calculation')) {
            questions.push("Calculate the compound annual growth rate for TSLA over the past 3 years");
            questions.push("What's the volatility of AMZN compared to the S&P 500?");
          }
          
          if (features.includes('ml-reasoning')) {
            questions.push("Analyze AAPL price trends and identify potential patterns");
            questions.push("What correlations exist between MSFT stock price and industry news sentiment?");
          }
          
          if (features.includes('planning')) {
            questions.push("Develop a research plan to evaluate if NVDA is currently overvalued");
            questions.push("What factors should I consider when evaluating renewable energy stocks?");
          }
          
          if (features.includes('validation')) {
            questions.push("Validate the reliability of recent earnings reports for META");
            questions.push("How confident should I be in analyst projections for AMD?");
          }
          
          if (features.includes('decision-making')) {
            questions.push("Should I invest in TSLA based on current market conditions?");
            questions.push("What's the risk-reward profile for investing in semiconductor stocks now?");
          }
          
          if (features.includes('operation')) {
            questions.push("Summarize the key financial metrics for AMZN");
            questions.push("What visualization would best show the relationship between GOOGL and AAPL stock movements?");
          }
        }

        // Limit to maximum 3 sample questions
        questions = questions.slice(0, 3);
        
        if (questions.length > 0) {
          sampleContainer.innerHTML = '<p><small><strong>Try asking:</strong> ' + 
            questions.map(q => `<a href="#" onclick="setQuestion(this.textContent); return false;">${q}</a>`).join(' • ') +
            '</small></p>';
        }
      }

      // Set question in input field
      function setQuestion(question) {
        const input = document.getElementById('stockSymbols');
        if (input) {
          input.value = question;
        }
      }

      // Format LLM Output Content
      function formatLLMOutput(outputText) {
        let processedText = outputText;
        
        let formattedHTML = '<div class="llm-formatted-output">';
        
        const lines = processedText.split('\n');
        let inAnalysisSection = false;
        let currentIteration = null;
        let inListSection = false;
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line === '') continue;
            
            let cleanContent = line.replace(/\*\*/g, '');
            
            if (line.includes("Using LiteLLM with model")) {
                formattedHTML += `
                    <div style="padding: 8px 12px; background-color: #eaf4ff; border-radius: 4px; 
                        margin-bottom: 15px; font-size: 14px; color: #0066cc; display: inline-block;">
                        ${cleanContent}
                    </div>`;
                continue;
            }
            
            if (line.includes("Iteration") && /\d+/.test(line)) {
                if (currentIteration !== null) {
                    formattedHTML += '</div>';
                }
                
                const iterNum = line.match(/\d+/)[0];
                formattedHTML += `
                    <div style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; 
                        border-left: 4px solid #4682b4; border-radius: 4px;">
                        <div style="font-weight: 600; color: #2c3e50; margin-bottom: 8px;">迭代 ${iterNum}</div>`;
                currentIteration = iterNum;
                continue;
            }
            
            if (line.includes("Retrieved data from")) {
                const functionNameMatch = line.match(/from (.+?)(\*\*)?$/);
                const functionName = functionNameMatch ? functionNameMatch[1].trim() : "unknown";
                
                formattedHTML += `
                    <div style="display: flex; align-items: center; padding: 8px 10px; background-color: #f0f7ff; 
                        border-radius: 6px; margin-bottom: 12px; border-left: 4px solid #28a745;">
                        <span style="margin-right: 10px; font-size: 16px;">✅</span>
                        <span>Data Retrieved Successfully: ${functionName}</span>
                    </div>`;
                continue;
            }
            
            if (line.includes("Early stop") || line.includes("No new data found")) {
                formattedHTML += `
                    <div style="display: flex; align-items: center; padding: 8px 10px; background-color: #f0f7ff; 
                        border-radius: 6px; margin-bottom: 12px; border-left: 4px solid #dc3545;">
                        <span style="margin-right: 10px; font-size: 16px;">⚠️</span>
                        <span>${cleanContent}</span>
                    </div>`;
                continue;
            }
            
            if (line.includes("LLM is satisfied with the data")) {
                formattedHTML += `
                    <div style="display: flex; align-items: center; padding: 8px 10px; background-color: #f0f7ff; 
                        border-radius: 6px; margin-bottom: 12px;">
                        <span style="margin-right: 10px; font-size: 16px;">🔍</span>
                        <span>Data Collection Complete, Starting Analysis...</span>
                    </div>`;
                continue;
            }
            
            if (line.includes("Investment Insight:")) {
                inAnalysisSection = true;
                if (currentIteration !== null) {
                    formattedHTML += '</div>'; 
                    currentIteration = null;
                }
                
                formattedHTML += `
                    <div style="margin-top: 20px; padding: 15px; background-color: #f8fdff; 
                        border: 1px solid #e1f0fb; border-radius: 8px;">
                        <div style="font-weight: bold; font-size: 18px; color: #0056b3; 
                            margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e1f0fb;">
                            Investment Insight Analysis
                        </div>
                        <div style="line-height: 1.6; color: #333;">`;
                continue;
            }
            
            if (inAnalysisSection && (line.match(/^\d+\./) || line.startsWith('-') || line.startsWith('*'))) {
                if (!inListSection) {
                    inListSection = true;
                    formattedHTML += '<ul style="margin-left: 20px; margin-bottom: 15px;">';
                }
                
                const listContent = line.replace(/^\d+\.\s*|-\s*|\*\s*/, '');
                formattedHTML += `<li style="margin-bottom: 8px;">${listContent}</li>`;
                
                if (i + 1 >= lines.length || 
                    !(lines[i+1].trim().match(/^\d+\./) || 
                      lines[i+1].trim().startsWith('-') || 
                      lines[i+1].trim().startsWith('*'))) {
                    inListSection = false;
                    formattedHTML += '</ul>';
                }
                continue;
            }
            
            if (line.includes("\\[") && line.includes("\\]")) {
                formattedHTML += `
                    <div style="background-color: #f9f9f9; padding: 10px; border-radius: 4px; 
                        margin: 10px 0; overflow-x: auto;">
                        ${line}
                    </div>`;
                continue;
            }
            
            if (inAnalysisSection) {
                let formattedLine = line;
                
                formattedLine = formattedLine.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                
                formattedLine = formattedLine.replace(/\*([^*]+)\*/g, '<em>$1</em>');
                
                formattedLine = formattedLine.replace(/`([^`]+)`/g, '<code style="background-color: #f5f5f5; padding: 2px 4px; border-radius: 3px;">$1</code>');
                
                formattedHTML += `<p>${formattedLine}</p>`;
            } else {
                formattedHTML += `<p>${cleanContent}</p>`;
            }
        }
        
        if (inAnalysisSection) {
            formattedHTML += '</div></div>';
        } else if (currentIteration !== null) {
            formattedHTML += '</div>';
        }
        
        formattedHTML += '</div>';
        return formattedHTML;
    }

    const style = document.createElement('style');
    style.textContent = `
        .loading-indicator {
            text-align: left;
            padding: 20px;
            color: #4682b4;
            font-weight: bold;
        }
        
        .llm-formatted-output {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: left;
        }
        
        .llm-formatted-output ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        .llm-formatted-output li {
            margin-bottom: 8px;
        }
        
        .llm-formatted-output code {
            background-color: #f5f5f5;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .llm-formatted-output p {
            margin-bottom: 10px;
        }
    `;
    document.head.appendChild(style);




    </script>
  </body>
</html>